# Yuho v5 PRD - Generated 2026-02-01
# Priority: (A) MVP/critical path, (B) Important, (C) Can parallelize
# Tags: +parser +ast +transpile +cli +lsp +mcp +llm +test +verify +library +statutes +config

# ============================================================================
# PARSER: tree-sitter grammar and Python bindings
# ============================================================================

(B) Add tree-sitter queries for syntax highlighting (keywords, types, literals, comments, operators) +parser
(B) Add tree-sitter queries for code folding (statute blocks, match arms, struct bodies) +parser
(B) Add tree-sitter queries for indentation rules +parser

# ============================================================================
# AST: Internal representation and semantic analysis
# ============================================================================

(B) Implement TypeInferenceVisitor that annotates each ExprNode with inferred type +ast
(B) Implement TypeCheckVisitor that validates type consistency and reports type errors +ast
(B) Implement ScopeAnalysisVisitor that builds symbol tables and resolves references +ast
(B) Implement ExhaustivenessChecker for match expressions using pattern matrix algorithm +ast
(B) Implement ReachabilityChecker that warns on unreachable match arms (dead code) +ast
(B) Implement OverlapDetector that warns when match arm patterns overlap (legal ambiguity) +ast
(C) Implement ConstantFolder that evaluates compile-time constant expressions +ast
(C) Implement DeadCodeEliminator that removes provably unreachable branches +ast

# ============================================================================
# TRANSPILATION: Multi-target code generation
# ============================================================================

(B) Implement LaTeXTranspiler with legal document preamble (article class, section formatting) +transpile
(B) Implement LaTeX statute formatting: section numbers, margin notes, cross-references +transpile
(B) Implement LaTeX penalty tables with imprisonment/fine columns +transpile
(B) Implement LaTeX illustration blocks with gray background and italic text +transpile
(B) Add LaTeX to PDF compilation via subprocess call to pdflatex/xelatex +transpile
(B) Implement Mermaid subgraph grouping for nested match expressions +transpile
(B) Implement Alloy run/check command generation for bounded model checking +transpile
(C) Implement TranspilerRegistry singleton mapping TranspileTarget to Transpiler instances +transpile

# ============================================================================
# CLI: Command-line interface with rich error messages
# ============================================================================

(A) Set up Click-based CLI entry point with --version, --help, --verbose flags +cli
(A) Implement `yuho check <file>` command: parse, build AST, run semantic analysis +cli
(A) Implement rich error formatting: source line display, caret pointing to error location +cli
(A) Implement error suggestions using Levenshtein distance for typos in keywords/identifiers +cli
(A) Implement `yuho transpile <file> -t <target>` with target validation +cli
(A) Implement `yuho transpile` output modes: stdout (default), -o <file>, --dir <directory> +cli
(A) Implement `yuho transpile --all` to generate all targets at once into output directory +cli
(A) Implement `yuho explain <file>` command that invokes LLM for natural language explanation +cli
(A) Implement `yuho explain --section <num>` to explain specific statute section only +cli
(A) Implement `yuho explain --interactive` for follow-up questions in REPL mode +cli
(A) Implement `yuho serve` command to start MCP server on configurable port +cli
(A) Implement `yuho serve --stdio` for stdio-based MCP transport (editor integration) +cli
(A) Implement `yuho contribute <file>` command: validate .yh file and associated tests +cli
(A) Implement `yuho contribute --package` to create distributable .yhpkg archive +cli
(B) Implement `yuho init` command to scaffold new statute project with template files +cli
(B) Implement `yuho fmt <file>` command for canonical formatting +cli
(B) Implement `yuho test <file>` command to run associated test files +cli
(B) Add --json flag to all commands for machine-readable output +cli
(B) Add --color/--no-color flags with auto-detection of terminal capabilities +cli
(B) Add --quiet flag to suppress non-error output +cli
(C) Implement shell completion scripts for bash, zsh, fish +cli
(C) Implement `yuho lsp` command to start LSP server (for editors that invoke directly) +cli

# ============================================================================
# LSP: Full Language Server Protocol implementation
# ============================================================================

(A) Set up pygls-based LSP server with TextDocumentSyncKind.Incremental +lsp
(A) Implement textDocument/didOpen handler: parse document, cache AST, publish diagnostics +lsp
(A) Implement textDocument/didChange handler: incremental re-parse, update AST cache +lsp
(A) Implement textDocument/didClose handler: clean up document state +lsp
(A) Implement diagnostic generation from parser errors with DiagnosticSeverity.Error +lsp
(A) Implement diagnostic generation from semantic errors (type errors, unresolved refs) +lsp
(A) Implement diagnostic generation from warnings (unreachable code, shadowed bindings) +lsp
(A) Implement textDocument/completion for keywords (match, struct, statute, fn, import) +lsp
(A) Implement textDocument/completion for built-in types (money, percent, date, duration, etc.) +lsp
(A) Implement textDocument/completion for struct field names based on type context +lsp
(A) Implement textDocument/completion for function names from current scope +lsp
(B) Implement textDocument/hover showing type information for expressions +lsp
(B) Implement textDocument/hover showing doc-comments for functions and statutes +lsp
(B) Implement textDocument/definition for go-to-definition on identifiers +lsp
(B) Implement textDocument/definition for go-to-definition on imports (open .yh file) +lsp
(B) Implement textDocument/references to find all usages of a symbol +lsp
(B) Implement textDocument/rename with workspace-wide symbol renaming +lsp
(B) Implement textDocument/documentSymbol returning statute/function/struct hierarchy +lsp
(B) Implement workspace/symbol for project-wide symbol search +lsp
(B) Implement textDocument/formatting using canonical formatter +lsp
(B) Implement textDocument/rangeFormatting for selection formatting +lsp
(B) Implement textDocument/codeAction for quick fixes (add missing import, fix typo) +lsp
(B) Implement textDocument/codeLens showing "Run tests" above statute definitions +lsp
(C) Implement textDocument/semanticTokens for enhanced syntax highlighting +lsp
(C) Implement textDocument/inlayHints showing inferred types inline +lsp
(C) Implement textDocument/foldingRange for code folding regions +lsp
(C) Implement workspace/didChangeConfiguration for runtime config updates +lsp

# ============================================================================
# MCP: Model Context Protocol server exposing all functionality
# ============================================================================

(A) Set up FastMCP-based server with stdio and HTTP transports +mcp
(A) Define MCP tool: yuho_check(file_content: str) -> {valid: bool, errors: list} +mcp
(A) Define MCP tool: yuho_transpile(file_content: str, target: str) -> {output: str} +mcp
(A) Define MCP tool: yuho_explain(file_content: str, section: str | None) -> {explanation: str} +mcp
(A) Define MCP tool: yuho_parse(file_content: str) -> {ast: dict} for AST inspection +mcp
(A) Define MCP tool: yuho_format(file_content: str) -> {formatted: str} +mcp
(A) Define MCP tool: yuho_complete(file_content: str, line: int, col: int) -> {completions: list} +mcp
(A) Define MCP tool: yuho_hover(file_content: str, line: int, col: int) -> {info: str} +mcp
(A) Define MCP tool: yuho_definition(file_content: str, line: int, col: int) -> {location: dict} +mcp
(B) Define MCP tool: yuho_references(file_content: str, line: int, col: int) -> {locations: list} +mcp
(B) Define MCP tool: yuho_symbols(file_content: str) -> {symbols: list} +mcp
(B) Define MCP tool: yuho_diagnostics(file_content: str) -> {diagnostics: list} +mcp
(B) Define MCP tool: yuho_validate_contribution(file_content: str, tests: list) -> {valid: bool, results: list} +mcp
(B) Define MCP tool: yuho_library_search(query: str) -> {statutes: list} for statute library search +mcp
(B) Define MCP tool: yuho_library_get(section: str) -> {statute: dict} to retrieve statute by section +mcp
(B) Define MCP tool: yuho_statute_to_yuho(natural_text: str) -> {yuho_code: str} LLM-assisted transpilation +mcp
(A) Define MCP resource: yuho://grammar returning tree-sitter grammar source +mcp
(A) Define MCP resource: yuho://types returning built-in type definitions +mcp
(A) Define MCP resource: yuho://library/{section} returning statute source by section number +mcp
(B) Define MCP resource: yuho://docs/{topic} returning reference documentation +mcp
(B) Implement MCP prompts: explain_statute, convert_to_yuho, analyze_coverage +mcp
(C) Add MCP server health check endpoint +mcp
(C) Add MCP request logging with configurable verbosity +mcp

# ============================================================================
# LLM: Local-first with Ollama/HuggingFace, cloud fallback
# ============================================================================

(A) Define LLMProvider abstract base class with generate(prompt: str, max_tokens: int) -> str +llm
(A) Define LLMConfig dataclass: provider (ollama|huggingface|openai|anthropic), model_name, api_key, base_url +llm
(A) Implement OllamaProvider using httpx to call local Ollama API at configurable host:port +llm
(A) Implement OllamaProvider model availability check and automatic pull if missing +llm
(A) Implement HuggingFaceProvider using transformers library for local inference +llm
(A) Implement HuggingFaceProvider model download and caching via huggingface_hub +llm
(A) Implement HuggingFaceProvider device selection: CUDA if available, else CPU +llm
(B) Implement OpenAIProvider using openai SDK with configurable base_url for API-compatible services +llm
(B) Implement AnthropicProvider using anthropic SDK +llm
(A) Implement LLMProviderFactory that instantiates provider from LLMConfig +llm
(A) Implement provider fallback chain: try local first, fall back to cloud if configured +llm
(A) Define prompt template for statute explanation: system prompt with legal context, user prompt with .yh code +llm
(A) Define prompt template for statute-to-Yuho conversion: examples, grammar summary, input statute text +llm
(B) Implement streaming response support for real-time output in CLI +llm
(B) Implement response caching with content-hash keys to avoid repeated LLM calls +llm
(B) Implement rate limiting for cloud providers with exponential backoff +llm
(C) Implement token counting for context window management +llm
(C) Implement prompt compression for long statutes exceeding context window +llm

# ============================================================================
# CONFIG: User configuration system
# ============================================================================

(A) Define config file location: ~/.config/yuho/config.toml +config
(A) Define config schema: [llm], [transpile], [lsp], [mcp] sections +config
(A) Implement config loading with defaults, file override, env var override, CLI flag override +config
(A) Implement [llm] config: provider, model, ollama_host, huggingface_cache, api_keys +config
(B) Implement [transpile] config: default_target, latex_compiler, output_dir +config
(B) Implement [lsp] config: diagnostic_severity_levels, completion_trigger_chars +config
(B) Implement [mcp] config: host, port, allowed_origins, auth_token +config
(B) Implement `yuho config show` command to display current configuration +config
(B) Implement `yuho config set <key> <value>` command for runtime config updates +config
(C) Implement config file validation with helpful error messages for invalid values +config

# ============================================================================
# TEST: Property-based testing with Hypothesis
# ============================================================================

(A) Define Hypothesis strategy for generating valid Yuho literal expressions +test
(A) Define Hypothesis strategy for generating valid struct definitions +test
(A) Define Hypothesis strategy for generating valid match expressions with N arms +test
(A) Define Hypothesis strategy for generating valid statute blocks +test
(A) Define Hypothesis strategy for generating complete valid .yh modules +test
(A) Implement round-trip invariant test: parse(pretty_print(parse(src))) == parse(src) +test
(A) Implement AST well-formedness invariant: all nodes have valid source locations +test
(A) Implement type preservation invariant: typeof(expr) == typeof(constant_fold(expr)) +test
(B) Implement exhaustiveness invariant: generated match exprs pass exhaustiveness check +test
(B) Implement reachability invariant: no generated match arms are unreachable +test
(B) Implement JSON round-trip invariant: from_json(to_json(ast)) == ast +test
(B) Implement transpilation determinism: transpile(ast) == transpile(ast) (no randomness) +test
(B) Implement cross-transpiler consistency: json_ast parsed from JSON equals original AST +test
(C) Implement fuzzing harness for parser with arbitrary byte sequences +test
(C) Implement differential testing against v4 Lark parser for compatible inputs +test

# ============================================================================
# VERIFY: Formal verification with Alloy and Z3
# ============================================================================

(B) Implement Alloy model generator from statute AST for bounded model checking +verify
(B) Implement Alloy analyzer subprocess invocation with timeout +verify
(B) Implement Alloy counterexample parser to surface violations as diagnostics +verify
(B) Define Alloy assertion: no_contradictory_elements (statute elements don't contradict) +verify
(B) Define Alloy assertion: penalty_ordering (more serious crimes have higher penalties) +verify
(C) Implement Z3 solver integration via z3-solver Python bindings +verify
(C) Implement Z3 constraint generation from match-case conditions +verify
(C) Implement Z3 satisfiability check for "is this pattern reachable?" queries +verify
(C) Implement Z3 model extraction to generate concrete test cases +verify

# ============================================================================
# LIBRARY: User-contributed statute repository
# ============================================================================

(B) Define contribution format: directory with statute.yh, test_statute.yh, metadata.toml +library
(B) Define metadata.toml schema: section_number, title, jurisdiction, contributor, version +library
(B) Implement contribution validator: parse .yh, run tests, check metadata completeness +library
(B) Implement .yhpkg archive format: gzipped tarball with signature file +library
(B) Implement library index: JSON file mapping section numbers to package metadata +library
(B) Implement library search by section number, title keyword, jurisdiction +library
(B) Implement library install command: download .yhpkg, verify signature, extract to ~/.yuho/library +library
(C) Implement library publish command: upload to configured registry URL +library
(C) Implement library update command: check for newer versions of installed packages +library

# ============================================================================
# STATUTES: Implement 10+ Penal Code sections for language breadth
# ============================================================================

(A) Implement S299 Culpable Homicide: demonstrate mens rea conditions with match-case +statutes
(A) Implement S300 Murder: demonstrate exception handling via first-match-wins priority +statutes
(A) Implement S319 Hurt: demonstrate physical element definitions +statutes
(A) Implement S378 Theft: demonstrate property offense with intent elements +statutes
(A) Implement S383 Extortion: demonstrate compound offense with multiple elements +statutes
(A) Implement S390 Robbery: demonstrate offense defined by combination of other offenses +statutes
(A) Implement S403 Dishonest Misappropriation: demonstrate possession-based offense +statutes
(A) Implement S415 Cheating: migrate existing v4 implementation to v5 tree-sitter AST +statutes
(A) Implement S420 Cheating and Dishonestly Inducing Delivery: demonstrate aggravated offense +statutes
(B) Implement S463 Forgery: demonstrate document-related offense +statutes
(B) Implement S499 Defamation: demonstrate speech-based offense with exceptions +statutes
(B) Implement S503 Criminal Breach of Trust: demonstrate fiduciary offense +statutes
(C) Write comprehensive test suite for each implemented statute using Hypothesis +statutes
(C) Create example illustrations for each statute showing typical fact patterns +statutes

# ============================================================================
# NEOVIM: LSP extension with tree-sitter highlighting
# ============================================================================

(B) Create nvim-yuho plugin structure: lua/yuho/init.lua, queries/, ftdetect/ +neovim
(B) Implement filetype detection for .yh files in ftdetect/yuho.vim +neovim
(B) Bundle tree-sitter-yuho parser for nvim-treesitter integration +neovim
(B) Write tree-sitter highlight queries in queries/yuho/highlights.scm +neovim
(B) Write tree-sitter indent queries in queries/yuho/indents.scm +neovim
(B) Write tree-sitter fold queries in queries/yuho/folds.scm +neovim
(B) Implement LSP client configuration connecting to `yuho lsp` +neovim
(B) Implement on_attach function enabling completion, diagnostics, formatting +neovim
(C) Add which-key integration for Yuho-specific keybindings +neovim
(C) Add telescope.nvim integration for statute symbol search +neovim
(C) Add lualine.nvim integration showing current statute section in statusline +neovim

# ============================================================================
# ROADMAP: v6 items (visual editor and beyond)
# ============================================================================

(C) [v6] Design Scratch-like block palette for Yuho constructs +roadmap
(C) [v6] Implement drag-and-drop block editor using Blockly or custom React components +roadmap
(C) [v6] Implement bidirectional sync between block editor and .yh source +roadmap
(C) [v6] Implement localhost-only web server serving visual editor UI +roadmap
(C) [v6] Implement block-to-AST and AST-to-block converters +roadmap
(C) [v6] Design guided statute builder wizard for non-programmers +roadmap
(C) [v6] Implement collaborative editing via CRDT synchronization +roadmap
